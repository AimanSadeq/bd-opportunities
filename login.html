<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>VIFM Portal - Login</title>

        <!-- Production Environment Configuration -->
        <script src="env.js"></script>

        <!-- Google Fonts - Open Sans -->
        <link
            href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Supabase Client Library -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <style>
            :root {
                /* VIFM Brand Colors */
                --vifm-primary: #010131;
                --vifm-accent: #5391d5;
                --vifm-dark: #111232;
                --vifm-navy: #121140;
                --vifm-off-white: #fefff9;

                /* Semantic Colors */
                --success: #22c55e;
                --error: #ef4444;
                --warning: #f59e0b;
                --info: #3b82f6;
                --background: var(--vifm-off-white);
                --surface: #ffffff;
                --text: var(--vifm-dark);
                --text-light: #64748b;
                --border: #e2e8f0;

                /* Gradients */
                --gradient-primary: linear-gradient(
                    135deg,
                    var(--vifm-primary) 0%,
                    var(--vifm-navy) 100%
                );
                --gradient-accent: linear-gradient(
                    135deg,
                    var(--vifm-accent) 0%,
                    var(--vifm-primary) 100%
                );
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    "Open Sans",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: var(--text);
                line-height: 1.6;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .background-pattern {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0.1;
                background-image: repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 35px,
                    rgba(255, 255, 255, 0.1) 35px,
                    rgba(255, 255, 255, 0.1) 70px
                );
                pointer-events: none;
            }

            /* Login Container */
            .login-container {
                width: 100%;
                max-width: 480px;
                margin: 0 1rem;
                position: relative;
                z-index: 1;
            }

            /* Login Card */
            .login-card {
                background: var(--surface);
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
                animation: slideUp 0.5s ease;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Card Header */
            .card-header {
                background: var(--gradient-primary);
                padding: 2.5rem 2rem;
                text-align: center;
                position: relative;
            }

            .card-header::after {
                content: "";
                position: absolute;
                bottom: -20px;
                left: 0;
                right: 0;
                height: 40px;
                background: var(--surface);
                border-radius: 50% 50% 0 0;
            }

            .logo-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .vifm-logo {
                height: 60px;
                width: auto;
                object-fit: contain;
            }

            .portal-title {
                color: white;
                font-size: 1.8rem;
                font-weight: 700;
                letter-spacing: -0.5px;
            }

            .portal-subtitle {
                color: rgba(255, 255, 255, 0.9);
                font-size: 0.9rem;
                font-weight: 400;
                margin-top: 0.5rem;
            }

            /* Card Body */
            .card-body {
                padding: 2.5rem 2rem 2rem;
            }

            .form-title {
                text-align: center;
                font-size: 1.3rem;
                font-weight: 600;
                color: var(--vifm-primary);
                margin-bottom: 2rem;
            }

            /* Form Elements */
            .form-group {
                margin-bottom: 1.5rem;
            }

            .form-label {
                display: block;
                margin-bottom: 0.5rem;
                font-size: 0.9rem;
                font-weight: 600;
                color: var(--text);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .form-input {
                width: 100%;
                padding: 0.875rem 1rem;
                border: 2px solid var(--border);
                border-radius: 10px;
                font-size: 1rem;
                font-family: inherit;
                transition: all 0.3s ease;
                background: var(--background);
            }

            .form-input:focus {
                outline: none;
                border-color: var(--vifm-accent);
                background: white;
                box-shadow: 0 0 0 3px rgba(83, 145, 213, 0.1);
            }

            .form-input.error {
                border-color: var(--error);
            }

            .input-icon {
                position: relative;
            }

            .input-icon i {
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                color: var(--text-light);
                cursor: pointer;
            }

            /* Buttons */
            .btn {
                width: 100%;
                padding: 0.875rem 1.5rem;
                border: none;
                border-radius: 10px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .btn-primary {
                background: var(--gradient-accent);
                color: white;
                box-shadow: 0 4px 15px rgba(83, 145, 213, 0.3);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(83, 145, 213, 0.4);
            }

            .btn-primary:disabled {
                background: #cbd5e1;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

            /* Messages */
            .message {
                padding: 0.875rem 1rem;
                border-radius: 10px;
                margin-bottom: 1.5rem;
                font-size: 0.875rem;
                animation: slideDown 0.3s ease;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.error {
                background: linear-gradient(135deg, #fee2e2, #fecaca);
                color: #dc2626;
                border-left: 4px solid #dc2626;
            }

            .message.success {
                background: linear-gradient(135deg, #dcfce7, #bbf7d0);
                color: #16a34a;
                border-left: 4px solid #16a34a;
            }

            .message.info {
                background: linear-gradient(135deg, #dbeafe, #bfdbfe);
                color: #1e40af;
                border-left: 4px solid #3b82f6;
            }

            .hidden {
                display: none !important;
            }

            /* Demo Info */
            .demo-info {
                margin-top: 2rem;
                padding: 1rem;
                background: linear-gradient(135deg, #f8fafc, #f1f5f9);
                border-radius: 10px;
                border: 1px solid var(--border);
            }

            .demo-title {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--vifm-primary);
                margin-bottom: 0.75rem;
            }

            .demo-users {
                display: grid;
                gap: 0.5rem;
            }

            .demo-user {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem;
                background: white;
                border-radius: 6px;
                font-size: 0.8rem;
            }

            .demo-user strong {
                color: var(--vifm-accent);
            }

            .role-badge {
                padding: 0.125rem 0.5rem;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .role-consultant {
                background: #e0e7ff;
                color: #4338ca;
            }

            .role-bd {
                background: #fef3c7;
                color: #d97706;
            }

            .role-admin {
                background: #fee2e2;
                color: #dc2626;
            }

            /* Loading Spinner */
            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Form Toggle */
            .form-toggle {
                display: flex;
                margin-bottom: 2rem;
                background: var(--background);
                border-radius: 10px;
                padding: 0.25rem;
            }

            .toggle-btn {
                flex: 1;
                padding: 0.75rem 1rem;
                border: none;
                background: transparent;
                color: var(--text-light);
                font-weight: 500;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .toggle-btn.active {
                background: var(--gradient-primary);
                color: white;
                box-shadow: 0 2px 10px rgba(1, 1, 49, 0.2);
            }

            .form-container {
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            /* Responsive */
            @media (max-width: 480px) {
                .card-body {
                    padding: 2rem 1.5rem 1.5rem;
                }

                .portal-title {
                    font-size: 1.5rem;
                }
            }

            .btn-secondary {
                background: #6b7280;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                width: 100%;
            }

            .btn-secondary:hover {
                background: #4b5563;
                transform: translateY(-1px);
            }
        </style>
    </head>
    <body>
        <div class="background-pattern"></div>

        <div class="login-container">
            <div class="login-card">
                <div class="card-header">
                    <div class="logo-container">
                        <img
                            src="vifm-logo.png"
                            alt="VIFM Logo"
                            class="vifm-logo"
                            onerror="this.style.display='none'; document.getElementById('logoText').style.display='block';"
                        />
                        <div id="logoText" style="display: none">
                            <div
                                style="
                                    color: white;
                                    font-size: 2rem;
                                    font-weight: 800;
                                "
                            >
                                VIFM
                            </div>
                        </div>
                        <div>
                            <div class="portal-title">
                                Business Development Portal
                            </div>
                            <div class="portal-subtitle">
                                Virginia Institute of Finance & Management
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Form Toggle Buttons -->
                    <div class="form-toggle">
                        <button
                            type="button"
                            class="toggle-btn active"
                            onclick="showLoginForm()"
                            id="loginTab"
                        >
                            Sign In
                        </button>
                        <button
                            type="button"
                            class="toggle-btn"
                            onclick="showRegisterForm()"
                            id="registerTab"
                        >
                            Create Account
                        </button>
                    </div>

                    <div id="messageArea"></div>

                    <!-- Login Form -->
                    <div id="loginFormContainer" class="form-container">
                        <h2 class="form-title">Sign In to Your Account</h2>

                        <form id="loginForm" onsubmit="handleLogin(event)">
                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input
                                    type="email"
                                    id="email"
                                    class="form-input"
                                    placeholder="your.email@vifm.ae"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <div class="input-icon">
                                    <input
                                        type="password"
                                        id="password"
                                        class="form-input"
                                        placeholder="Enter your password"
                                        required
                                    />
                                    <i
                                        onclick="togglePassword()"
                                        style="cursor: pointer"
                                        >👁️</i
                                    >
                                </div>
                            </div>

                            <button
                                type="submit"
                                id="loginBtn"
                                class="btn btn-primary"
                            >
                                Sign In
                            </button>

                            <button
                                type="button"
                                onclick="resetPassword()"
                                class="btn btn-secondary"
                                style="margin-top: 10px"
                            >
                                Reset Password
                            </button>
                        </form>
                    </div>

                    <!-- Registration Form -->
                    <div
                        id="registerFormContainer"
                        class="form-container hidden"
                    >
                        <h2 class="form-title">Create Your VIFM Account</h2>

                        <form
                            id="registerForm"
                            onsubmit="handleRegister(event)"
                        >
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input
                                    type="text"
                                    id="registerName"
                                    class="form-input"
                                    placeholder="Your full name"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Email Address</label>
                                <input
                                    type="email"
                                    id="registerEmail"
                                    class="form-input"
                                    placeholder="your.email@vifm.ae"
                                    required
                                />
                            </div>

                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <div class="input-icon">
                                    <input
                                        type="password"
                                        id="registerPassword"
                                        class="form-input"
                                        placeholder="Choose a secure password"
                                        required
                                    />
                                    <i
                                        onclick="toggleRegisterPassword()"
                                        style="cursor: pointer"
                                        >👁️</i
                                    >
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select
                                    id="registerRole"
                                    class="form-input"
                                    required
                                >
                                    <option value="">Select your role</option>
                                    <option value="consultant">
                                        Consultant
                                    </option>
                                    <option value="bd">
                                        Business Development Professional
                                    </option>
                                </select>
                            </div>

                            <button
                                type="submit"
                                id="registerBtn"
                                class="btn btn-primary"
                            >
                                Create Account
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Production Authentication System using Supabase

            // System ready flag
            let systemReady = false;
            let supabaseClient = null;

            // Initialize Supabase client without auto-redirect
            function initializeSupabase() {
                if (!window.env) {
                    console.error("Environment configuration not loaded");
                    return false;
                }

                try {
                    supabaseClient = window.supabase.createClient(
                        window.env.SUPABASE_URL,
                        window.env.SUPABASE_ANON_KEY,
                    );

                    console.log("✅ Supabase client initialized for login");
                    return true;
                } catch (error) {
                    console.error("Supabase initialization error:", error);
                    return false;
                }
            }

            // Wait for everything to load before enabling login
            document.addEventListener("DOMContentLoaded", function () {
                // Disable the login button initially
                const loginButton = document.querySelector(
                    'button[type="submit"]',
                );
                if (loginButton) {
                    loginButton.disabled = true;
                    loginButton.textContent = "Loading...";
                }

                setTimeout(() => {
                    console.log("Initializing authentication system...");

                    if (initializeSupabase()) {
                        console.log("✅ Authentication system ready!");
                        systemReady = true;

                        // Enable the login button
                        if (loginButton) {
                            loginButton.disabled = false;
                            loginButton.textContent = "Sign In";
                        }
                    } else {
                        console.error("❌ Authentication system not available");
                        if (loginButton) {
                            loginButton.textContent = "System Error";
                        }
                    }
                }, 500);
            });

            // Handle login with proper Supabase authentication
            async function handleLogin(event) {
                event.preventDefault();

                // Check if system is ready
                if (!systemReady) {
                    showMessage(
                        "error",
                        "System is still loading. Please wait a moment...",
                    );
                    return;
                }

                const email = document.getElementById("email").value.trim();
                const password = document.getElementById("password").value;
                const loginBtn = document.getElementById("loginBtn");

                // Validate input
                if (!email || !password) {
                    showMessage(
                        "error",
                        "Please enter both email and password",
                    );
                    return;
                }

                // Disable button and show loading
                loginBtn.disabled = true;
                loginBtn.innerHTML =
                    '<span class="spinner"></span> Signing in...';

                try {
                    // Use direct Supabase client for authentication
                    if (!supabaseClient) {
                        throw new Error("Authentication system not ready");
                    }

                    // Supabase authentication
                    const { data, error } =
                        await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password,
                        });

                    if (error) {
                        throw new Error(error.message);
                    }

                    if (!data.user) {
                        throw new Error("Login failed - no user returned");
                    }

                    // Get user profile from database
                    const { data: profile, error: profileError } =
                        await supabaseClient
                            .from("profiles")
                            .select("*")
                            .eq("email", email)
                            .single();

                    if (profileError || !profile) {
                        console.error("Profile fetch error:", profileError);
                        throw new Error("User profile not found");
                    }

                    console.log("✅ Login successful:", profile.full_name);
                    showMessage("success", "Login successful! Redirecting...");

                    // Redirect based on role
                    setTimeout(() => {
                        redirectBasedOnRole(profile.role);
                    }, 1000);
                } catch (error) {
                    console.error("Login error:", error);
                    showMessage(
                        "error",
                        error.message || "Login failed. Please try again.",
                    );

                    // Re-enable button
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = "Sign In";
                }
            }

            // Redirect based on user role
            function redirectBasedOnRole(role) {
                switch (role) {
                    case "consultant":
                        window.location.href = "phase1.html";
                        break;
                    case "bd":
                        window.location.href = "bd-module.html";
                        break;
                    case "admin":
                        window.location.href = "vifm-main-menu.html";
                        break;
                    default:
                        window.location.href = "vifm-main-menu.html";
                }
            }

            // Toggle password visibility for login
            function togglePassword() {
                const passwordInput = document.getElementById("password");
                const type =
                    passwordInput.type === "password" ? "text" : "password";
                passwordInput.type = type;
            }

            // Toggle password visibility for registration
            function toggleRegisterPassword() {
                const passwordInput =
                    document.getElementById("registerPassword");
                const type =
                    passwordInput.type === "password" ? "text" : "password";
                passwordInput.type = type;
            }

            // Form toggling functions
            function showLoginForm() {
                document
                    .getElementById("loginFormContainer")
                    .classList.remove("hidden");
                document
                    .getElementById("registerFormContainer")
                    .classList.add("hidden");
                document.getElementById("loginTab").classList.add("active");
                document
                    .getElementById("registerTab")
                    .classList.remove("active");
                clearMessages();
            }

            function showRegisterForm() {
                document
                    .getElementById("loginFormContainer")
                    .classList.add("hidden");
                document
                    .getElementById("registerFormContainer")
                    .classList.remove("hidden");
                document.getElementById("loginTab").classList.remove("active");
                document.getElementById("registerTab").classList.add("active");
                clearMessages();
            }

            // Clear messages
            function clearMessages() {
                const messageArea = document.getElementById("messageArea");
                messageArea.innerHTML = "";
                messageArea.classList.add("hidden");
            }

            // Handle registration
            async function handleRegister(event) {
                event.preventDefault();

                if (!systemReady) {
                    showMessage(
                        "error",
                        "System is still loading. Please wait a moment...",
                    );
                    return;
                }

                const name = document
                    .getElementById("registerName")
                    .value.trim();
                const email = document
                    .getElementById("registerEmail")
                    .value.trim();
                const password =
                    document.getElementById("registerPassword").value;
                const role = document.getElementById("registerRole").value;
                const registerBtn = document.getElementById("registerBtn");

                // Validate input
                if (!name || !email || !password || !role) {
                    showMessage("error", "Please fill in all fields");
                    return;
                }

                if (password.length < 6) {
                    showMessage(
                        "error",
                        "Password must be at least 6 characters long",
                    );
                    return;
                }

                // Disable button and show loading
                registerBtn.disabled = true;
                registerBtn.innerHTML =
                    '<span class="spinner"></span> Creating account...';

                try {
                    // Use direct Supabase client for registration
                    if (!supabaseClient) {
                        throw new Error("Authentication system not ready");
                    }

                    // Register the user with Supabase
                    const { data: authData, error: authError } =
                        await supabaseClient.auth.signUp({
                            email: email,
                            password: password,
                        });

                    if (authError) {
                        throw new Error(authError.message);
                    }

                    if (!authData.user) {
                        throw new Error(
                            "Registration failed - no user created",
                        );
                    }

                    // Create user profile in database
                    const { error: profileError } = await supabaseClient
                        .from("profiles")
                        .insert({
                            user_id: authData.user.id,
                            email: email,
                            full_name: name,
                            role: role,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString(),
                        });

                    if (profileError) {
                        console.error("Profile creation error:", profileError);
                        // User was created but profile failed - still show success
                    }

                    showMessage(
                        "success",
                        "Account created successfully! You can now sign in.",
                    );

                    // Switch to login form and populate email
                    setTimeout(() => {
                        showLoginForm();
                        document.getElementById("email").value = email;
                        document.getElementById("registerForm").reset();
                    }, 2000);
                } catch (error) {
                    console.error("Registration error:", error);
                    showMessage(
                        "error",
                        error.message ||
                            "Registration failed. Please try again.",
                    );
                } finally {
                    // Re-enable button
                    registerBtn.disabled = false;
                    registerBtn.textContent = "Create Account";
                }
            }

            // Show message
            function showMessage(type, message) {
                const messageArea = document.getElementById("messageArea");
                messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;

                // Auto-hide after 5 seconds unless it's an error
                if (type !== "error") {
                    setTimeout(() => {
                        messageArea.innerHTML = "";
                    }, 5000);
                }
            }

            // Manual password reset for admin user
            async function requestPasswordReset(email) {
                try {
                    if (!supabaseClient) {
                        throw new Error("Authentication system not ready");
                    }

                    console.log("Requesting password reset for:", email);

                    const { data, error } =
                        await supabaseClient.auth.resetPasswordForEmail(email, {
                            redirectTo:
                                window.location.origin + "/reset-password.html",
                        });

                    if (error) {
                        console.error("Password reset request failed:", error);
                        return false;
                    } else {
                        console.log("✅ Password reset email sent to:", email);
                        return true;
                    }
                } catch (error) {
                    console.error("Password reset error:", error);
                    return false;
                }
            }

            // Reset password function called by button
            async function resetPassword() {
                const email = document.getElementById("email").value;
                if (!email) {
                    showMessage(
                        "error",
                        "Please enter your email address first",
                    );
                    return;
                }

                const success = await requestPasswordReset(email);
                if (success) {
                    showMessage(
                        "success",
                        "Password reset email sent! Check your inbox and follow the instructions.",
                    );
                } else {
                    showMessage(
                        "error",
                        "Failed to send password reset email. Please try again.",
                    );
                }
            }

            // Initialize and check for existing session
            window.onload = async function () {
                console.log("VIFM Production System initializing...");

                try {
                    // Check for old localStorage sessions and clear them
                    if (
                        localStorage.getItem("session_token") ||
                        localStorage.getItem("user_data")
                    ) {
                        localStorage.removeItem("session_token");
                        localStorage.removeItem("user_data");
                        console.log("Cleared old localStorage session data");
                    }

                    // Initialize Supabase client
                    initializeSupabase();

                    console.log("✅ VIFM Production System ready");
                } catch (error) {
                    console.error("System initialization error:", error);
                    showMessage(
                        "error",
                        "System initialization error. Please refresh the page.",
                    );
                }
            };
        </script>
    </body>
</html>
