<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIFM Portal - Production System Test</title>
    
    <!-- Production Environment Configuration -->
    <script src="env.js"></script>
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- VIFM Supabase Configuration -->
    <script src="supabase.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #010131;
            border-bottom: 3px solid #5391D5;
            padding-bottom: 10px;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #e0e0e0;
        }
        .test-item.pass {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        .test-item.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-item.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .status {
            font-weight: bold;
            margin-right: 10px;
        }
        button {
            background: #5391D5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #4380c4;
        }
        .summary {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç VIFM Portal System Test</h1>
        
        <div id="testResults">
            <p>Running system checks...</p>
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="runTests()">üîÑ Run Production Tests</button>
            <button onclick="clearTestData()">üóëÔ∏è Clear Test Data</button>
            <button onclick="window.location.href='login.html'">üîê Go to Login</button>
            <button onclick="window.location.href='index.html'">üè† Go to Portal</button>
        </div>
        
        <div id="summary" class="summary" style="display:none;">
            <h3>Test Summary</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        // Production Test Functions
        const tests = {
            checkFiles: async function() {
                const requiredFiles = [
                    'index.html',
                    'login.html', 
                    'vifm-main-menu.html',
                    'phase1.html',
                    'bd-module.html',
                    'supabase.js'
                ];
                
                try {
                    let allExist = true;
                    for (const file of requiredFiles) {
                        const response = await fetch(file, { method: 'HEAD' });
                        if (!response.ok) allExist = false;
                    }
                    
                    return {
                        name: 'File Integrity Check',
                        pass: allExist,
                        message: allExist ? 'All required files present' : 'Some files missing'
                    };
                } catch (error) {
                    return {
                        name: 'File Integrity Check',
                        pass: false,
                        message: 'Error checking files: ' + error.message
                    };
                }
            },
            
            checkAuthSystem: function() {
                if (!window.VIFMSupabase) {
                    return {
                        name: 'Authentication System',
                        pass: false,
                        message: 'VIFM authentication system not loaded'
                    };
                }
                
                const hasAuth = window.VIFMSupabase.Auth;
                const hasDatabase = window.VIFMSupabase.Database;
                const hasRouteGuard = window.VIFMSupabase.RouteGuard;
                
                if (hasAuth && hasDatabase && hasRouteGuard) {
                    return {
                        name: 'Authentication System',
                        pass: true,
                        message: '‚úÖ Production auth system loaded'
                    };
                } else {
                    return {
                        name: 'Authentication System',
                        pass: false,
                        message: 'Missing auth components'
                    };
                }
            },
            
            checkSupabaseConnection: async function() {
                try {
                    if (!window.VIFMSupabase || !window.VIFMSupabase.Database) {
                        throw new Error('Database system not available');
                    }
                    
                    const result = await window.VIFMSupabase.Database.testConnection();
                    
                    return {
                        name: 'Database Connection',
                        pass: result.success,
                        message: result.message || (result.success ? 'Connected to Supabase' : 'Connection failed')
                    };
                } catch (error) {
                    return {
                        name: 'Database Connection',
                        pass: false,
                        message: 'Error: ' + error.message
                    };
                }
            },
            
            checkCRUDOperations: async function() {
                try {
                    if (!window.VIFMSupabase || !window.VIFMSupabase.Database) {
                        throw new Error('Database system not available');
                    }
                    
                    // Test data operations on profiles table
                    const testData = {
                        email: 'test_' + Date.now() + '@test.com',
                        full_name: 'Test User',
                        role: 'consultant'
                    };
                    
                    // Test CREATE
                    const created = await window.VIFMSupabase.Database.insert('profiles', testData);
                    
                    // Test READ
                    const profiles = await window.VIFMSupabase.Database.select('profiles', {
                        filter: { email: testData.email },
                        limit: 1
                    });
                    
                    // Test UPDATE
                    const updated = await window.VIFMSupabase.Database.update('profiles', created.id, {
                        full_name: 'Updated Test User'
                    });
                    
                    // Test DELETE
                    await window.VIFMSupabase.Database.delete('profiles', created.id);
                    
                    return {
                        name: 'CRUD Operations',
                        pass: true,
                        message: '‚úÖ Create, Read, Update, Delete all working'
                    };
                    
                } catch (error) {
                    return {
                        name: 'CRUD Operations',
                        pass: false,
                        message: 'CRUD error: ' + error.message
                    };
                }
            },
            
            checkSessionManagement: function() {
                // Check new session system
                const sessionData = sessionStorage.getItem('vifm_session');
                
                if (sessionData) {
                    try {
                        const session = JSON.parse(sessionData);
                        const isValid = new Date(session.expires_at) > new Date();
                        
                        return {
                            name: 'Session Management',
                            pass: isValid,
                            message: isValid ? 
                                `‚úÖ Valid session for: ${session.profile.full_name}` : 
                                'Session expired'
                        };
                    } catch (error) {
                        return {
                            name: 'Session Management',
                            pass: false,
                            message: 'Session data corrupted'
                        };
                    }
                } else {
                    return {
                        name: 'Session Management',
                        pass: null,
                        message: 'No active session (normal when not logged in)'
                    };
                }
            },
            
            checkSecurityFeatures: function() {
                const issues = [];
                
                // Check for old localStorage sessions
                if (localStorage.getItem('session_token') || localStorage.getItem('user_data')) {
                    issues.push('Old localStorage sessions found');
                }
                
                // Check HTTPS in production
                if (window.location.protocol === 'http:' && !window.location.hostname.includes('localhost')) {
                    issues.push('Not using HTTPS in production');
                }
                
                // Check for demo credentials visibility
                const demoVisible = document.querySelector('[data-demo-credentials]') !== null;
                if (demoVisible) {
                    issues.push('Demo credentials visible');
                }
                
                return {
                    name: 'Security Features',
                    pass: issues.length === 0,
                    message: issues.length === 0 ? 
                        '‚úÖ Security checks passed' : 
                        '‚ö†Ô∏è Issues: ' + issues.join(', ')
                };
            },
            
            checkBrowser: function() {
                const browser = navigator.userAgent;
                const isMobile = /iPhone|iPad|iPod|Android/i.test(browser);
                
                return {
                    name: 'Browser Compatibility',
                    pass: true,
                    message: `Browser: ${isMobile ? 'Mobile' : 'Desktop'} - Compatible`
                };
            },
            
            checkProtocol: function() {
                const protocol = window.location.protocol;
                
                if (protocol === 'file:') {
                    return {
                        name: 'Protocol Check',
                        pass: false,
                        message: 'Running from file:// - Should use HTTP server'
                    };
                }
                
                return {
                    name: 'Protocol Check',
                    pass: true,
                    message: `Running on ${protocol} - Good!`
                };
            }
        };
        
        async function runTests() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>üß™ Running production system tests...</p>';
            
            let passCount = 0;
            let failCount = 0;
            let warningCount = 0;
            const results = [];
            
            // Run each test sequentially
            for (const [testName, testFunc] of Object.entries(tests)) {
                try {
                    const result = await testFunc();
                    results.push(result);
                    
                    if (result.pass === true) passCount++;
                    else if (result.pass === false) failCount++;
                    else warningCount++;
                    
                } catch (error) {
                    results.push({
                        name: testName,
                        pass: false,
                        message: 'Test error: ' + error.message
                    });
                    failCount++;
                }
            }
            
            // Display results
            resultsDiv.innerHTML = '';
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = 'test-item';
                
                if (result.pass === true) {
                    div.className += ' pass';
                    div.innerHTML = `<span class="status">‚úÖ PASS</span> ${result.name}: ${result.message}`;
                    passCount++;
                } else if (result.pass === false) {
                    div.className += ' fail';
                    div.innerHTML = `<span class="status">‚ùå FAIL</span> ${result.name}: ${result.message}`;
                    failCount++;
                } else {
                    div.className += ' warning';
                    div.innerHTML = `<span class="status">‚ö†Ô∏è INFO</span> ${result.name}: ${result.message}`;
                    warningCount++;
                }
                
                resultsDiv.appendChild(div);
            });
            
            // Show summary
            const summaryDiv = document.getElementById('summary');
            const summaryContent = document.getElementById('summaryContent');
            summaryDiv.style.display = 'block';
            
            let overallStatus = 'üéâ All systems operational!';
            if (failCount > 0) {
                overallStatus = '‚ö†Ô∏è Some issues detected - check failed tests above';
            }
            
            summaryContent.innerHTML = `
                <p><strong>${overallStatus}</strong></p>
                <p>‚úÖ Passed: ${passCount} | ‚ùå Failed: ${failCount} | ‚ö†Ô∏è Warnings: ${warningCount}</p>
                <p>Test completed at: ${new Date().toLocaleTimeString()}</p>
            `;
        }
        
        function clearData() {
            if (confirm('This will clear all local data. Are you sure?')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('All local data cleared! Refresh the page to start fresh.');
                location.reload();
            }
        }
        
        // Run tests on load
        window.onload = function() {
            runTests();
        };
    </script>
</body>
</html>
